# ç›¸å…³ API

## [Performance](https://developer.mozilla.org/zh-CN/docs/Web/API/Performance)

ç”± window å…¨å±€ä½œç”¨åŸŸæä¾›ï¼Œå¯ç›´æ¥è°ƒç”¨

- **performance.mark()** â€”â€” æ ‡è®°ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œè¡¨ç¤ºä»è¾“å…¥ URL å¹¶å›è½¦åˆ°è°ƒç”¨æ­¤æ–¹æ³•çš„æ—¶é—´

- **performance.getEntries()** â€”â€” è·å–ä»è¾“å…¥ URL å¹¶å›è½¦åˆ°å„ä¸ªé˜¶æ®µçš„æ—¶é—´æˆ³

## [PerformanceObserver.observe()](https://developer.mozilla.org/en-US/docs/Web/API/PerformanceObserver/observe)

- ç”¨äºè§‚å¯Ÿä¼ å…¥çš„å‚æ•°ä¸­æŒ‡å®šçš„ [æ€§èƒ½æ¡ç›®ç±»å‹](https://developer.mozilla.org/en-US/docs/Web/API/PerformanceEntry/entryType) çš„é›†åˆ

  ```js
  const observer = new PerformanceObserver()

  observer.observe({
    entryTypes: [''],
    type: '',
    buffered: true,
  })
  ```

- å¸¸ç”¨ entryTypes

  - `paint` â€”â€” LPã€LCP

  - `largest-contentful-paint` â€”â€” LCP

- buffered å¿…é¡»å’Œ type å±æ€§æ­é…ä½¿ç”¨

# å‰ç«¯æ€§èƒ½æŒ‡æ ‡

## ç®€å•ä»‹ç»

- ç™½å±æ—¶é—´ `First Paint` â€”â€” ä»è¾“å…¥ URL å¼€å§‹åˆ°é¡µé¢ä»»æ„åƒç´ ç‚¹å˜åŒ–

  ```js
  function getFirstPaint() {
    new PerformanceObserver((entryList, observer) => {
      let entries = entryList.getEntries()
      for (let i = 0; i < entries.length; i++) {
        if (entries[i].name === 'first-paint') {
          console.log('FP', entries[i].startTime)
        }
      }
      observer.disconnect()
    }).observe({ entryTypes: ['paint'] })
  }
  ```

- é¦–æ¬¡å†…å®¹ç»˜åˆ¶ `First Content Paint` â€”â€” é¡µé¢ç»˜åˆ¶ç¬¬ä¸€ä¸ªå…ƒç´ 

  ```js
  function getFirstContentPaint() {
    new PerformanceObserver((entryList, observer) => {
      let entries = entryList.getEntries()
      for (let i = 0; i < entries.length; i++) {
        if (entries[i].name === 'first-contentful-paint') {
          console.log('FCP', entries[i].startTime)
        }
      }
      observer.disconnect()
    }).observe({ entryTypes: ['paint'] })
  }
  ```

- é¦–é¡µæ—¶é—´ â€”â€” å½“ onload äº‹ä»¶è§¦å‘çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯æ•´ä¸ªé¦–é¡µåŠ è½½å®Œæˆçš„æ—¶å€™

  ```js
  function getFirstPage() {
    return performance.timing.loadEventEnd - performance.timing.fetchStart
  }
  ```

- æœ€å¤§å†…å®¹ç»˜åˆ¶ `Largest Contentful Paint` â€”â€” ç”¨äºè®°å½•è§†çª—å†…æœ€å¤§çš„å…ƒç´ ç»˜åˆ¶çš„æ—¶é—´ï¼ŒLCP ä¼šéšç€é¡µé¢æ¸²æŸ“å˜åŒ–è€Œå˜åŒ–ï¼Œå› ä¸ºé¡µé¢ä¸­çš„æœ€å¤§å…ƒç´ åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‘ç”Ÿæ”¹å˜ã€‚

  ```js
  function getLCP() {
    new PerformanceObserver((entryList, observer) => {
      let entries = entryList.getEntries()
      const lastEntry = entries[entries.length - 1]
      observer.disconnect()
      console.log('LCP', lastEntry.renderTime || lastEntry.loadTime)
    }).observe({ entryTypes: ['largest-contentful-paint'] })
  }
  ```

- é¦–æ¬¡å¯äº¤äº’æ—¶é—´ `TTI` â€”â€” ä» FCP æŒ‡æ ‡åå¼€å§‹è®¡ç®—

  ```js
  function getTTI() {
    return performance.timing.domInteractive - performance.timing.fetchStart
  }
  ```

- é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ `First Input Delay` â€”â€” è®°å½•åœ¨ FCP å’Œ TTI ä¹‹é—´ç”¨æˆ·é¦–æ¬¡ä¸é¡µé¢äº¤äº’æ—¶å“åº”çš„å»¶è¿Ÿã€‚

  ```javascript
  function getFirstInputDelay() {
    new PerformanceObserver((entryList, observer) => {
      let firstInput = entryList.getEntries()[0]

      if (firstInput) {
        const FID = firstInput.processingStart - firstInput.startTime
        console.log('FID', FID)
      }

      observer.disconnect()
    }).observe({ type: 'first-input', buffered: true })
  }
  ```

- ğŸŒŸ ç´¯è®¡ä½ç§»åç§» `Cumulative Layout Shift` â€”â€” æ¨èå€¼ä¸ºä½äº 0.1

  ```js
  function getCumulativeLayoutShift() {
    try {
      let cumulativeLayoutShiftScore = 0

      const observer = new PerformanceObserver((list) => {
        for (const entry of list.getEntries()) {
          if (!entry.hadRecentInput) {
            cumulativeLayoutShiftScore += entry.value
          }
        }
      }).observe({ type: 'layout-shift', buffered: true })

      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          observer.takeRecords()
          observer.disconnect()
        }
      })
    } catch (e) {}
  }
  ```

  - ğŸŒŸ ä»äº¤äº’åˆ°ä¸‹ä¸€æ¬¡ç»˜åˆ¶çš„å»¶æ—¶ `Interaction to Next Paint` â€”â€” ä¸ FID ä¸€æ ·å±äºäº¤äº’ä½“éªŒæŒ‡æ ‡

## ä¸‰ä¸ªæ ¸å¿ƒç½‘é¡µæ€§èƒ½æŒ‡æ ‡

- è¡¡é‡åŠ è½½é€Ÿåº¦ â€”â€” [æœ€å¤§å†…å®¹ç»˜åˆ¶ `Largest Content Paint`](https://web.dev/articles/optimize-lcp?hl=zh-cn)

  ![LCP](https://web.dev/static/articles/vitals/image/largest-contentful-paint-ea2e6ec5569b6.svg?hl=zh-cn)

- è¡¡é‡äº’åŠ¨æ€§ â€”â€” [ä»äº¤äº’åˆ°ä¸‹ä¸€æ¬¡ç»˜åˆ¶çš„å»¶æ—¶ `Interaction to Next Paint`](https://web.dev/articles/optimize-inp?hl=zh-cn)

  ![INP](https://web.dev/static/articles/vitals/image/inp-thresholds.svg?hl=zh-cn)

- è¡¡é‡è§†è§‰ç¨³å®šæ€§ â€”â€” [ç´¯è®¡ä½ç§»åç§» `Cumulative Layout Shift`](https://web.dev/articles/optimize-cls?hl=zh-cn)

  ![CLS](https://web.dev/static/articles/vitals/image/cumulative-layout-shift-t-5d49b9b883de4.svg?hl=zh-cn)

- ~~é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ `First Input Delay`~~ å·²è¢« INP æ›¿ä»£

## ä½¿ç”¨ JavaScript è¡¡é‡æ ¸å¿ƒç½‘é¡µæŒ‡æ ‡ â€”â€” [Web Vitals](https://web.dev/articles/vitals?hl=zh-cn)

```js
import { onCLS, onINP, onLCP } from 'web-vitals'

function sendToAnalytics(metric) {
  const body = JSON.stringify(metric)

  ;(navigator.sendBeacon && navigator.sendBeacon('/analytics', body)) ||
    fetch('/analytics', { body, method: 'POST', keepalive: true })
}

onCLS(sendToAnalytics)
onINP(sendToAnalytics)
onLCP(sendToAnalytics)
```

## å½±å“æ€§èƒ½çš„å› ç´ ä»¥åŠ[æ”¹è¿›æ–¹æ³•](https://web.dev/articles/top-cwv?hl=zh-cn)

- å½±å“ç™½å±æ—¶é—´ã€LCPã€é¦–é¡µçš„ä¸»è¦åŸå› 

  - ç½‘é€Ÿé—®é¢˜ â€”â€” æé«˜ç½‘é€Ÿ | éƒ¨ç½² CDN ä»¥ç¼©çŸ­ç”¨æˆ·ä¸èŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»

  - JS åŒ…çš„å¤§å°

  - æ˜¯å¦å¯ç”¨ JS å¼‚æ­¥åŠ è½½

- ä¼˜åŒ–ç™½å±æ—¶é—´

  - æé«˜ç½‘é€Ÿ | éƒ¨ç½² CDN ä»¥ç¼©çŸ­ç”¨æˆ·ä¸èŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»

  - ä¸åœ¨å¤´éƒ¨ä½¿ç”¨ script æ ‡ç­¾

  - å»ºç«‹ç¼“å­˜ï¼Œæé«˜ä¸‹æ¬¡åŠ è½½çš„é€Ÿåº¦

  - å¼€å¯ gzip å‹ç¼©

- ä¼˜åŒ– CLS

  - å¸¸å˜åŠ¨å…ƒç´  â€”â€” ä½¿å…¶è„±ç¦»æ–‡æ¡£æµ | å æ®å›ºå®šä½ç½®å¹¶éšè—

  - ä½ç§»æ“ä½œ â€”â€” ä½¿ç”¨åŠ¨ç”»

  - å®šä¹‰å›¾ç‰‡ â€”â€” ç»™å®šå®½é«˜

- ä¼˜åŒ–ç”¨æˆ·å¯æ“ä½œæ—¶é—´

- JavaScript åŠ è½½é€Ÿåº¦ä¼˜åŒ– â€”â€” æ‡’åŠ è½½

- å“åº”æ—¶é—´å†…é¿å…**è¿‡å¤šè¿ç®—** â€”â€” é€‚å½“ä½¿ç”¨ Web Worker å¼€å¯æ–°çº¿ç¨‹
